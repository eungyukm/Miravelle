{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <h2>Create a 3D Model</h2>

    <form id="meshForm">
        <div class="mb-3">
            <label for="prompt" class="form-label">Prompt</label>
            <input type="text" class="form-control" id="prompt" name="prompt" required>
        </div>

        <div class="mb-3">
            <label for="art_style" class="form-label">Art Style</label>
            <select class="form-select" id="art_style" name="art_style">
                <option value="realistic">Realistic</option>
                <option value="sculpture">Sculpture</option>
            </select>
        </div>

        <button type="submit" id="generateBtn" class="btn btn-dark w-100">Generate Model</button>

        <div id="loadingSpinner" style="display: none; text-align: center; margin-top: 10px;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Generating model, please wait...</p>
        </div>

        <p id="error-message" class="text-danger mt-3"></p>
    </form>

    <!-- ğŸ”¥ ì‘ì—… ìƒíƒœ í™•ì¸ ë²„íŠ¼ -->
    <div id="statusSection" style="display: none; margin-top: 20px;">
        <h3>Model Generation Status</h3>
        <p id="jobIdText"></p>
        <button id="checkStatusBtn" class="btn btn-dark w-100">Check Status</button>
    </div>
</div>

<script>
    let currentJobId = localStorage.getItem("currentJobId") || null;

    document.addEventListener("DOMContentLoaded", function () {
        console.log("ğŸ”¥ [DEBUG] create_mesh.html ë¡œë“œë¨!");

        const meshForm = document.getElementById("meshForm");
        const loadingSpinner = document.getElementById("loadingSpinner");
        const statusSection = document.getElementById("statusSection");
        const checkStatusBtn = document.getElementById("checkStatusBtn");
        const errorMessage = document.getElementById("error-message");
        const generateBtn = document.getElementById("generateBtn");
        const jobIdText = document.getElementById("jobIdText");

        function updateStatusButton() {
            checkStatusBtn.disabled = !currentJobId;
        }

        // ğŸ”¥ í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ì „ ì‘ì—… IDê°€ ìˆìœ¼ë©´ í‘œì‹œ
        if (currentJobId) {
            jobIdText.textContent = `Job ID: ${currentJobId}`;
            statusSection.style.display = "block";
            updateStatusButton();
        }

        meshForm.addEventListener("submit", function(event) {
            event.preventDefault();

            const formData = new FormData(meshForm);
            const jsonData = Object.fromEntries(formData.entries());

            loadingSpinner.style.display = "block";
            generateBtn.disabled = true;
            errorMessage.textContent = "";
            statusSection.style.display = "none";

            fetch("/workspace/meshes/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify(jsonData)
            })
            
            .then(response => response.json().then(data => ({ status: response.status, body: data })))
            .then(({ status, body }) => {
                if ((status === 200 || status === 202) && body.job_id) { // âœ… 202ë„ ì²˜ë¦¬
                    alert("âœ… Mesh ìƒì„± ìš”ì²­ ì„±ê³µ! ì‘ì—… ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.");
                    currentJobId = body.job_id;
                    localStorage.setItem("currentJobId", currentJobId); // âœ… job_id ì €ì¥
                    jobIdText.textContent = `Job ID: ${currentJobId}`;
                    statusSection.style.display = "block";
                    updateStatusButton();
                } else {
                    throw new Error(body.error || "Unknown error occurred");
                }
            })
            .catch(error => {
                console.error("API ìš”ì²­ ì‹¤íŒ¨:", error);
                errorMessage.textContent = "âŒ Error: " + error.message;
            })
            .finally(() => {
                loadingSpinner.style.display = "none";
                generateBtn.disabled = false;
            });
        });

        // ğŸ”¥ Check Status ë²„íŠ¼ í´ë¦­ ì‹œ ìƒíƒœ í™•ì¸ í›„ ë¯¸ë¦¬ë³´ê¸° í˜ì´ì§€ë¡œ ì´ë™
        checkStatusBtn.addEventListener("click", function () {
            if (!currentJobId) return;

            checkStatusBtn.disabled = true; // ğŸ”¥ ì¤‘ë³µ í´ë¦­ ë°©ì§€
            checkStatusBtn.textContent = "Checking...";
            setTimeout(() => {
                checkStatusBtn.disabled = false;
                checkStatusBtn.textContent = "Check Status";
            }, 3000);  // 3ì´ˆ í›„ ë‹¤ì‹œ í™œì„±í™”

            fetch(`/workspace/${currentJobId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === "completed") {
                        window.location.href = `/workspace/${currentJobId}/preview/`; // âœ… ì™„ë£Œë˜ë©´ ì´ë™
                    } else {
                        alert("âš ï¸ ëª¨ë¸ì´ ì•„ì§ ìƒì„± ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.");
                    }
                })
                .catch(error => {
                    console.error("ğŸ”´ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:", error);
                    alert("âŒ ìƒíƒœ í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ.");
                });
        });
    });
</script>

{% endblock content %}
