{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <h2>Model Preview</h2>

    <!-- ğŸ”¥ ì„œë²„ì—ì„œ ì „ë‹¬ëœ ê°’ í™•ì¸ -->
    <p><strong>Mesh ID:</strong> <span id="meshIdText">{{ mesh_id }}</span></p>

    {% if thumbnail_url %}
        <p>ğŸ”¥ [DEBUG] ì¸ë„¤ì¼ URL: {{ thumbnail_url }}</p>
        <img src="{{ thumbnail_url }}" alt="Mesh Preview" style="max-width: 100%; height: auto;">
    {% else %}
        <p>âŒ [DEBUG] ì¸ë„¤ì¼ URL ì—†ìŒ</p>
    {% endif %}

    {% if video_url %}
        <p>ğŸ”¥ [DEBUG] ë¹„ë””ì˜¤ URL: {{ video_url }}</p>
        <video controls style="width: 100%;">
            <source src="{{ video_url }}" type="video/mp4">
            Your browser does not support the video tag.
        </video>
    {% else %}
        <p>âŒ [DEBUG] ë¹„ë””ì˜¤ URL ì—†ìŒ</p>
    {% endif %}

    <!-- ğŸ”¥ JavaScriptì—ì„œ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ë¶ˆëŸ¬ì™€ì„œ ì ìš© -->
    <div id="previewSection">
        <img id="previewImage" src="" alt="Mesh Preview" style="display: none; max-width: 100%; height: auto;">
        <video id="previewVideo" controls style="width: 100%; display: none;">
            <source id="videoSource" src="" type="video/mp4">
            Your browser does not support the video tag.
        </video>
    </div>

    <!-- ğŸ”¥ ì •ì œ ë²„íŠ¼ -->
    <button id="refineMeshBtn" class="btn btn-dark w-100"">Refine Mesh</button>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        console.log("ğŸ”¥ [DEBUG] preview_mesh.html ë¡œë“œë¨!");

        // âœ… Mesh ID ì„¤ì •
        const meshIdElement = document.getElementById("meshIdText");
        const jobId = meshIdElement ? meshIdElement.textContent.trim() : null;

        if (!jobId) {
            alert("âš ï¸ ìœ íš¨í•œ ì‘ì—… IDê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        function fetchMeshStatus() {
            console.log("ğŸ”„ [DEBUG] ëª¨ë¸ ìƒíƒœ í™•ì¸ ì¤‘...");

            fetch(`/workspace/${jobId}/preview/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log("âœ… [DEBUG] ëª¨ë¸ ë°ì´í„° ê°€ì ¸ì˜´:", data);

                        if (data.thumbnail_url) {
                            document.getElementById("previewImage").src = data.thumbnail_url;
                            document.getElementById("previewImage").style.display = "block";
                        }

                        if (data.video_url) {
                            document.getElementById("videoSource").src = data.video_url;
                            document.getElementById("previewVideo").style.display = "block";
                            document.getElementById("previewVideo").load();
                        }

                        // âœ… ì¸ë„¤ì¼ê³¼ ë¹„ë””ì˜¤ê°€ ìˆìœ¼ë©´ ë°˜ë³µ ìš”ì²­ ì¤‘ë‹¨
                        if (data.thumbnail_url && data.video_url) {
                            clearInterval(statusCheckInterval);
                        }
                    } else {
                        console.log("âŒ [DEBUG] ëª¨ë¸ ë°ì´í„°ê°€ ì•„ì§ ì—†ìŒ.");
                    }
                })
                .catch(error => {
                    console.error("âŒ [ERROR] ëª¨ë¸ ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨:", error);
                });
        }

        // ğŸ”¥ ìµœì´ˆ ì‹¤í–‰ + 5ì´ˆë§ˆë‹¤ ë°˜ë³µ ì‹¤í–‰ (ìµœëŒ€ 2ë¶„ ë™ì•ˆ)
        fetchMeshStatus();
        let statusCheckInterval = setInterval(fetchMeshStatus, 5000);

        // 2ë¶„ í›„ì—ë„ ì•ˆ ëœ¨ë©´ ì¤‘ë‹¨
        setTimeout(() => {
            clearInterval(statusCheckInterval);
            console.log("â³ [DEBUG] 2ë¶„ ì´ˆê³¼: ëª¨ë¸ì´ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•ŠìŒ.");
        }, 120000);
    });
</script>

{% endblock content %}
