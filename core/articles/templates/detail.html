{% extends "base.html" %}

{% block content %}
<div class="container">
    <h1>{{ article.title }}'s Detail</h1>
    
    <div class="card">
        <!-- Three.js Î†åÎçîÎßÅ ÎåÄÏÉÅ -->
        <div id="three-container" style="width: 100%; height: 600px;"></div>
        <!-- <img src="{{ article.image.url }}" class="card-img-top" style="max-width: 100%; max-height: 100%; object-fit: contain;"> -->
        <div class="card-body">
            <h5 class="card-title">{{ article.title }}</h5>
            <form method="post" action="{% url "articles:articlelike" article.pk "‚ù§Ô∏è" %}" style="display: inline-block; margin-right: 15px;">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline-light">‚ù§Ô∏è</button>
                <p class="card-text" style="display: inline-block;"><strong>{{ article.like_count }}</strong></p>
            </form>
            <form method="post" action="{% url "articles:articlelike" article.pk "ü§®" %}" style="display: inline-block; margin-right: 10px;">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline-light">ü§®</button>
                <p class="card-text" style="display: inline-block;"><strong>{{ article.dislike_count }}</strong></p>
            </form>
            <p class="card-text"><strong>Model prompt : </strong> {{ article.model_prompt }}</p>
            <p class="card-text"><strong>Texture prompt :</strong> {{ article.texture_prompt }}</p>
            <p class="card-text"><strong>Tags :</strong> {{ article.tags }}</p>
            <p class="card-text"><strong>Model seed :</strong> {{ article.model_seed }}</p>
            <p class="card-text"><strong>Created date :</strong> {{ article.created_at }}</p>
            
            <a href="{% url 'articles:main' %}" class="btn btn-dark">Back to Main</a>
        </div>
    </div>
</div>

<!-- Three.js & FBXLoader -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fflate@0.8.2/umd/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/loaders/FBXLoader.js"></script>

<script>
    // Three.js Í∏∞Î≥∏ ÏÑ§Ï†ï
    const container = document.getElementById('three-container');
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
    camera.position.set(0, 2, 5); // Ï¥àÍ∏∞ Ïπ¥Î©îÎùº ÏúÑÏπò

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    container.appendChild(renderer.domElement);

    // Ï°∞Î™Ö Ï∂îÍ∞Ä
    const light = new THREE.DirectionalLight(0xffffff, 1);
    light.position.set(10, 10, 10);
    scene.add(light);

    let loadedModel = null; // Î™®Îç∏ Ï†ÄÏû•Ïö© Î≥ÄÏàò
    let isDragging = false; // ÎßàÏö∞Ïä§ ÎìúÎûòÍ∑∏ ÏÉÅÌÉú
    let isPanning = false; // ÎßàÏö∞Ïä§ Ìú† Î≤ÑÌäº ÎìúÎûòÍ∑∏ ÏÉÅÌÉú
    let previousMousePosition = { x: 0, y: 0 };

    // FBX Î°úÎìú
    const loader = new THREE.FBXLoader();
    loader.load('/static/models/downloaded_test_model.fbx', (fbx) => {
        scene.add(fbx);
        fbx.scale.set(0.05, 0.05, 0.05);
        loadedModel = fbx; // Î™®Îç∏ Ï†ÄÏû•
    }, undefined, (error) => {
        console.error('FBX Load Error:', error);
    });

    // Ïï†ÎãàÎ©îÏù¥ÏÖò Î£®ÌîÑ
    function animate() {
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
    }
    animate();

    // Ï∞Ω ÌÅ¨Í∏∞ Î≥ÄÍ≤Ω Ïãú Î†åÎçîÎü¨ ÌÅ¨Í∏∞ ÏóÖÎç∞Ïù¥Ìä∏
    window.addEventListener('resize', () => {
        renderer.setSize(container.clientWidth, container.clientHeight);
        camera.aspect = container.clientWidth / container.clientHeight;
        camera.updateProjectionMatrix();
    });

    // ÎßàÏö∞Ïä§ ÎìúÎûòÍ∑∏Î°ú Î™®Îç∏ ÌöåÏ†Ñ (ÏôºÏ™Ω Î≤ÑÌäº)
    function onMouseDown(event) {
        if (event.button === 0) { // ÏôºÏ™Ω Î≤ÑÌäº ÌÅ¥Î¶≠ ‚Üí Î™®Îç∏ ÌöåÏ†Ñ
            isDragging = true;
            previousMousePosition = { x: event.clientX, y: event.clientY };
            container.style.cursor = "grabbing"; // Ïª§ÏÑú Î≥ÄÍ≤Ω
        } else if (event.button === 1) { // Ìú† Î≤ÑÌäº ÌÅ¥Î¶≠ ‚Üí Ïπ¥Î©îÎùº Ïù¥Îèô
            isPanning = true;
            previousMousePosition = { x: event.clientX, y: event.clientY };
            container.style.cursor = "move"; // Ïª§ÏÑú Î≥ÄÍ≤Ω
        }
    }

    function onMouseMove(event) {
        if (isDragging && loadedModel) {
            const deltaX = event.clientX - previousMousePosition.x;
            const deltaY = event.clientY - previousMousePosition.y;
            
            loadedModel.rotation.x += deltaY * 0.005;
            loadedModel.rotation.y += deltaX * 0.005;
        }

        if (isPanning) {
            const deltaX = event.clientX - previousMousePosition.x;
            const deltaY = event.clientY - previousMousePosition.y;

            camera.position.x -= deltaX * 0.01;
            camera.position.y += deltaY * 0.01;

            camera.position.x = Math.max(-5, Math.min(5, camera.position.x));
            camera.position.y = Math.max(0, Math.min(5, camera.position.y));
        }

        previousMousePosition = { x: event.clientX, y: event.clientY };
    }

    function onMouseUp(event) {
        if (event.button === 0) {
            isDragging = false;
            container.style.cursor = "grab";
        } else if (event.button === 1) {
            isPanning = false;
            container.style.cursor = "grab";
        }
    }

    // Ïπ¥Î©îÎùº Ï§å (ÎßàÏö∞Ïä§ Ìú†)
    const minDistance = 2;
    const maxDistance = 10;

    function onMouseWheel(event) {
        event.preventDefault();

        let zoomAmount = event.deltaY * 0.01;
        let newDistance = camera.position.z + zoomAmount;

        if (newDistance >= minDistance && newDistance <= maxDistance) {
            camera.position.z = newDistance;
        }
    }

    // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
    container.addEventListener("mousedown", onMouseDown);
    container.addEventListener("mousemove", onMouseMove);
    container.addEventListener("mouseup", onMouseUp);
    container.addEventListener("wheel", onMouseWheel, { passive: false });
</script>
{% endblock %}
