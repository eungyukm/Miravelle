{% extends "base.html" %}

{% block content %}
<div class="container">
    <h1>{{ article.title }}'s Detail</h1>
    
    <div class="card">
        <!-- Three.js Î†åÎçîÎßÅ ÎåÄÏÉÅ -->
        <div id="three-container" style="width: 100%; height: 600px;"></div>
        <!-- <img src="{{ article.image.url }}" class="card-img-top" style="max-width: 100%; max-height: 100%; object-fit: contain;"> -->
        <div class="card-body">
            <h5 class="card-title">{{ article.title }}</h5>
            <form method="post" action="{% url "articles:articlelike" article.pk "‚ù§Ô∏è" %}" style="display: inline-block; margin-right: 15px;">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline-light">‚ù§Ô∏è</button>
                <p class="card-text" style="display: inline-block;"><strong>{{ article.like_count }}</strong></p>
            </form>
            <form method="post" action="{% url "articles:articlelike" article.pk "ü§®" %}" style="display: inline-block; margin-right: 10px;">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline-light">ü§®</button>
                <p class="card-text" style="display: inline-block;"><strong>{{ article.dislike_count }}</strong></p>
            </form>
            <p class="card-text"><strong>Model prompt : </strong> {{ article.create_prompt }}</p>
            <p class="card-text"><strong>Texture prompt :</strong> {{ article.texture_prompt }}</p>
            <p class="card-text"><strong>Tags :</strong> {{ article.tags }}</p>
            <p class="card-text"><strong>Model seed :</strong> {{ article.model_seed }}</p>
            <p class="card-text"><strong>Created date :</strong> {{ article.created_at }}</p>
            
            <a href="{% url 'articles:main' %}" class="btn btn-dark">Back to Main</a>
        </div>
    </div>
</div>

<!-- Three.js & GLTFLoader -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/loaders/GLTFLoader.js"></script>

<script>
    // Three.js Í∏∞Î≥∏ ÏÑ§Ï†ï
    const container = document.getElementById('three-container');
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
    camera.position.set(0, 2, 5); // Ï¥àÍ∏∞ Ïπ¥Î©îÎùº ÏúÑÏπò

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    container.appendChild(renderer.domElement);

    // Ï°∞Î™Ö Ï∂îÍ∞Ä
    const light = new THREE.DirectionalLight(0xffffff, 1);
    light.position.set(10, 10, 10);
    scene.add(light);

    let loadedModel = null;
    let isDragging = false;
    let isPanning = false;
    let previousMousePosition = { x: 0, y: 0 };

    // Azure Blob StorageÏóêÏÑú Î™®Îç∏ Î°úÎìú
    const loader = new THREE.GLTFLoader();
    const blobUrl = 'https://miravelledevstorage.blob.core.windows.net/meshy-3d-assets/tasks/01957d90-e660-728c-9387-84b23aa5dc6a/models/model.glb';

    loader.setCrossOrigin('anonymous'); // CORS ÏÑ§Ï†ï Ï∂îÍ∞Ä

    loader.load(
        blobUrl,
        (gltf) => {
            const model = gltf.scene;
            scene.add(model);
            model.scale.set(0.5, 0.5, 0.5); // Î™®Îç∏ ÌÅ¨Í∏∞ Ï°∞Ï†ï
            loadedModel = model;
        },
        (xhr) => {
            console.log(`Loading: ${(xhr.loaded / xhr.total) * 100}% loaded`);
        },
        (error) => {
            console.error('GLTF Load Error:', error);
        }
    );

    // Ïï†ÎãàÎ©îÏù¥ÏÖò Î£®ÌîÑ
    function animate() {
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
    }
    animate();

    // Ï∞Ω ÌÅ¨Í∏∞ Î≥ÄÍ≤Ω Ïãú Î†åÎçîÎü¨ ÌÅ¨Í∏∞ ÏóÖÎç∞Ïù¥Ìä∏
    window.addEventListener('resize', () => {
        renderer.setSize(container.clientWidth, container.clientHeight);
        camera.aspect = container.clientWidth / container.clientHeight;
        camera.updateProjectionMatrix();
    });

    // ÎßàÏö∞Ïä§ ÎìúÎûòÍ∑∏Î°ú Î™®Îç∏ ÌöåÏ†Ñ (ÏôºÏ™Ω Î≤ÑÌäº)
    function onMouseDown(event) {
        if (event.button === 0) {
            isDragging = true;
            previousMousePosition = { x: event.clientX, y: event.clientY };
            container.style.cursor = "grabbing";
        } else if (event.button === 1) {
            isPanning = true;
            previousMousePosition = { x: event.clientX, y: event.clientY };
            container.style.cursor = "move";
        }
    }

    function onMouseMove(event) {
        if (isDragging && loadedModel) {
            const deltaX = event.clientX - previousMousePosition.x;
            const deltaY = event.clientY - previousMousePosition.y;
            loadedModel.rotation.y += deltaX * 0.005;
            loadedModel.rotation.x += deltaY * 0.005;
        }

        if (isPanning) {
            const deltaX = event.clientX - previousMousePosition.x;
            const deltaY = event.clientY - previousMousePosition.y;
            camera.position.x -= deltaX * 0.01;
            camera.position.y += deltaY * 0.01;
            camera.position.x = Math.max(-5, Math.min(5, camera.position.x));
            camera.position.y = Math.max(0, Math.min(5, camera.position.y));
        }

        previousMousePosition = { x: event.clientX, y: event.clientY };
    }

    function onMouseUp(event) {
        isDragging = false;
        isPanning = false;
        container.style.cursor = "grab";
    }

    // Ïπ¥Î©îÎùº Ï§å (ÎßàÏö∞Ïä§ Ìú†)
    const minDistance = 2;
    const maxDistance = 10;

    function onMouseWheel(event) {
        event.preventDefault();
        let zoomAmount = event.deltaY * 0.01;
        let newDistance = camera.position.z + zoomAmount;
        if (newDistance >= minDistance && newDistance <= maxDistance) {
            camera.position.z = newDistance;
        }
    }

    // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
    container.addEventListener("mousedown", onMouseDown);
    container.addEventListener("mousemove", onMouseMove);
    container.addEventListener("mouseup", onMouseUp);
    container.addEventListener("wheel", onMouseWheel, { passive: false });
</script>
{% endblock %}
